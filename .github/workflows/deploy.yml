name: Deploy Scraper (CF Gen2 + Cloud Scheduler)

on:
  push:
    branches: [ "main" ]
    paths:
      - 'cloud_function/scraper_cars/**'
      - '.github/workflows/deploy-scraper.yml'
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  REGION: ${{ vars.REGION }}
  FUNCTION_NAME: ${{ vars.SCRAPER_FUNCTION_NAME || vars.FUNCTION_NAME || 'craigslist-scraper' }}
  FUNCTION_DIR: cloud_function/scraper_cars
  ENTRY_POINT: entrypoint
  RUNTIME: python312
  BUCKET_NAME: ${{ vars.BUCKET_NAME }}
  RUNTIME_SA: ${{ vars.RUNTIME_SA }}
  DEPLOYER_SA: ${{ vars.DEPLOYER_SA }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
  SCHEDULE_BODY: ${{ vars.SCHEDULE_BODY || '{"pages":1,"max":3}' }}
  CRON_EXPR: "0 * * * *"              # :00 every hour (ET below)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Echo config
        run: |
          echo "PROJECT_ID=${PROJECT_ID}"
          echo "REGION=${REGION}"
          echo "FUNCTION_NAME=${FUNCTION_NAME}"
          echo "FUNCTION_DIR=${FUNCTION_DIR}"
          echo "ENTRY_POINT=${ENTRY_POINT}"
          echo "RUNTIME_SA=${RUNTIME_SA}"
          echo "DEPLOYER_SA=${DEPLOYER_SA}"

      - name: Deploy Cloud Function (Gen2, HTTP, authenticated)
        run: |
          set -euo pipefail
          SA_ARGS=()
          if [[ -n "${RUNTIME_SA:-}" ]]; then
            gcloud iam service-accounts describe "${RUNTIME_SA}" >/dev/null 2>&1
            SA_ARGS=(--service-account="${RUNTIME_SA}")
          fi
          gcloud functions deploy "${FUNCTION_NAME}" \
            --gen2 \
            --region="${REGION}" \
            --runtime="${RUNTIME}" \
            --source="${FUNCTION_DIR}" \
            --entry-point="${ENTRY_POINT}" \
            --trigger-http \
            --no-allow-unauthenticated \
            "${SA_ARGS[@]}" \
            --set-env-vars="PROJECT_ID=${PROJECT_ID},BUCKET_NAME=${BUCKET_NAME}" \
            --memory=512Mi \
            --timeout=540s

      - name: Grant invoker to deployer SA
        run: |
          gcloud functions add-invoker-policy-binding "${FUNCTION_NAME}" \
            --gen2 --region "${REGION}" \
            --member="serviceAccount:${DEPLOYER_SA}"

      - name: Get Function URL
        id: cfurl
        run: |
          URL=$(gcloud functions describe "${FUNCTION_NAME}" --gen2 --region "${REGION}" --format='value(serviceConfig.uri)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "FUNCTION_URL=${URL}"

      - name: Ensure Scheduler API enabled (fail clearly if not)
        id: apicheck
        shell: bash
        run: |
          set -euo pipefail
          if gcloud services list --enabled --filter="cloudscheduler.googleapis.com" --format="value(config.name)" | grep -q cloudscheduler.googleapis.com; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            if gcloud services enable cloudscheduler.googleapis.com; then
              echo "enabled=true" >> "$GITHUB_OUTPUT"
            else
              echo "Cloud Scheduler API enable failed. Grant roles/serviceusage.serviceUsageAdmin to ${DEPLOYER_SA} or enable manually."
              exit 1
            fi
          fi

      - name: Ensure Scheduler can mint OIDC as deployer SA (tokenCreator)
        run: |
          set -euo pipefail
          PROJECT_NUMBER="$(gcloud projects describe "${PROJECT_ID}" --format='value(projectNumber)')"
          SCHED_AGENT="service-${PROJECT_NUMBER}@gcp-sa-cloudscheduler.iam.gserviceaccount.com"
          echo "Scheduler agent: ${SCHED_AGENT}"
          gcloud iam service-accounts add-iam-policy-binding "${DEPLOYER_SA}" \
            --member="serviceAccount:${SCHED_AGENT}" \
            --role="roles/iam.serviceAccountTokenCreator"

      - name: Create/Update Cloud Scheduler job (:00 ET)
        shell: bash
        run: |
          set -euo pipefail
          JOB_NAME="${FUNCTION_NAME}-hourly"
          URL="${{ steps.cfurl.outputs.url }}"
          [[ -z "${URL}" ]] && { echo "Function URL empty"; exit 1; }
          if gcloud scheduler jobs describe "$JOB_NAME" --location="${REGION}" >/dev/null 2>&1; then
            gcloud scheduler jobs update http "$JOB_NAME" \
              --location="${REGION}" \
              --schedule="${CRON_EXPR}" \
              --time-zone="America/New_York" \
              --uri="${URL}" \
              --http-method=POST \
              --message-body='${{ env.SCHEDULE_BODY }}' \
              --oidc-service-account-email="${DEPLOYER_SA}" \
              --oidc-token-audience="${URL}"
          else
            gcloud scheduler jobs create http "$JOB_NAME" \
              --location="${REGION}" \
              --schedule="${CRON_EXPR}" \
              --time-zone="America/New_York" \
              --uri="${URL}" \
              --http-method=POST \
              --message-body='${{ env.SCHEDULE_BODY }}' \
              --oidc-service-account-email="${DEPLOYER_SA}" \
              --oidc-token-audience="${URL}"
          fi
